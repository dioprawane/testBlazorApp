# Nom du workflow visible sur GitHub
name: .NET Actions

# Quand d√©clencher ce workflow
on:
  push: # √Ä chaque push
    branches:
      - master        # Sur la branche master
  pull_request: # √Ä chaque pull request
    branches:
      - master        # Vers master
      - features      # Vers features
    paths-ignore:
      - TestGitVersion.cs
      - Properties/AssemblyInfo.cs

# D√©finition des t√¢ches √† ex√©cuter
jobs:
  build:
    runs-on: ubuntu-latest   # Utilise la derni√®re version d'une VM Ubuntu h√©berg√©e par GitHub

    # Liste des actions √† effectuer
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4  # Clone le code source du d√©p√¥t/R√©cup√®re les fichiers du d√©p√¥t
      with:
        fetch-depth: 0  # Permet √† GitVersion d‚Äôavoir l'historique complet   
    
    - name: Write TestGitVersion.cs file
      uses: DamianReeves/write-file-action@master
      with:
        path: TestGitVersion.cs
        write-mode: overwrite
        contents: |
          // Fichier g√©n√©r√© automatiquement par GitHub Actions
          using System;

          namespace AutoGenerated
          {
              public static class TestGitVersion
              {
                  public static void Print()
                  {
                      Console.WriteLine("Fichier g√©n√©r√© automatiquement depuis GitHub Actions √† la date du ${date}");
                      Console.WriteLine("Last Test");
                  }
              }
          }

    - name: Commit TestGitVersion.cs UNIQUEMENT dans la branche cible
      if: github.ref == 'refs/heads/master' || github.base_ref == 'master' || github.base_ref == 'features'
      uses: Andro999b/push@v1.3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.base_ref }}
        force: true
        message: 'Ajout automatique de TestGitVersion.cs avant merge dans ${{ github.base_ref }}'

    - name: Clone main project GestionBudget
      run: git clone https://github.com/dioprawane/testBlazorApp.git ../GestionBudget

    - name: Clone test project
    # Clonage du projet de tests depuis un d√©p√¥t externe
      run: git clone https://github.com/dioprawane/GestionBudgetTest.git ../GestionBudgetTest

    - name: Install .NET sdk
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.302'  # Installe la version 8.0.302 .NET du SDK 

    # Ces √©tapes sont utilis√©es pour se connecter √† MySQL
    # - name: Set environment variables
    #   run: echo "PASSWORDMYSQL=${{ secrets.PASSWORDMYSQL }}" >> $GITHUB_ENV

    # - name: Install MySQL Client
    #   run: sudo apt-get install -y mysql-client

    # - name: Test MySQL Connection
    #   env:
    #     PASSWORDMYSQL: ${{ secrets.PASSWORDMYSQL }}
    #   run: |
    #     mysql --host=pro69valo.urdom.ad.recouv --user=perfeco --password=$PASSWORDMYSQL dialogue_gestion -e "SHOW DATABASES;"

    - name: Intallation/Restauration des d√©pendances
      #run: dotnet restore    # Restaure/installe les d√©pendances NuGet
      # Restaure/installe les d√©pendances NuGet des projets de base et de tests
      run: |
        dotnet restore GestionBudg√©taire.csproj
        dotnet restore ../GestionBudgetTest/GestionBudgetaireTest.csproj

    - name: Install GitVersion 
    # Installer la version 6.3.0 de GitVersion (outil de gestion de version bas√© sur Git)
      uses: gittools/actions/gitversion/setup@v0.12.0
      with:
        versionSpec: '6.3.0'

    - name: Run GitVersion
    # Ex√©cute GitVersion pour g√©n√©rer les m√©tadonn√©es de version
      id: gitversion
      uses: gittools/actions/gitversion/execute@v0.12.0

    - name: Show GitVersion output
    # Affiche la version g√©n√©r√©e par GitVersion dans les logs
      run: |
        echo "GitVersion (fullSemVer): ${{ steps.gitversion.outputs.fullSemVer }}"

    - name: Inject version into AssemblyInfo.cs
    # Injecte la version GitVersion dans le fichier AssemblyInfo.cs
      run: |
        dotnet new tool-manifest --force
        dotnet tool install GitVersion.Tool --version 6.3.0
        dotnet tool run dotnet-gitversion \
          /updateassemblyinfo Properties/AssemblyInfo.cs \
          /ensureassemblyinfo \
          /config gitversion.yml
          
    - name: Commit AssemblyInfo.cs UNIQUEMENT dans la branche cible
      if: github.ref == 'refs/heads/master' || github.base_ref == 'master' || github.base_ref == 'features'
      uses: Andro999b/push@v1.3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.base_ref }}
        force: true
        message: 'Mise √† jour automatique de AssemblyInfo.cs avec GitVersion - ${{ github.run_number }}'
    
    #- name: Compilation
      #run: dotnet build --configuration Release --no-restore  # Compile l‚Äôapplication en mode Release sans refaire restore

    - name: Build project
    # Compile le projet principal avec la version g√©n√©r√©e
      #run: dotnet build --configuration Release --no-restore /p:Version=${{ steps.gitversion.outputs.fullSemVer }}
      run: dotnet build GestionBudg√©taire.csproj --configuration Release --no-restore /p:Version=${{ steps.gitversion.outputs.assemblyFileVersion }}

    - name: Build test project
    # Compile le projet de test
      run: |
        dotnet build ../GestionBudgetTest/GestionBudgetaireTest.csproj --no-restore --verbosity quiet
    
    - name: Run tests
    # Ex√©cute les tests avec sortie console d√©taill√©e et export au format TRX
      run: |
        dotnet test ../GestionBudgetTest/GestionBudgetaireTest.csproj \
          --no-restore \
          --no-build \
          --verbosity minimal \
          --logger "console;verbosity=detailed" \
          --logger "trx;LogFileName=TestResults.trx" \
          --results-directory ./TestResults       
        
    - name: Upload test results
    # Envoie les r√©sultats des tests (fichier TRX) comme artefact GitHub Actions
      uses: actions/upload-artifact@v4
      with:
        name: TestResults
        path: ./TestResults

    - name: Bump and push Git tag
      if: github.ref == 'refs/heads/master'
      run: |
        echo "üîç R√©cup√©ration du dernier tag Git..."
        last_tag=$(git describe --tags `git rev-list --tags --max-count=1`)
        echo "üïì Dernier tag d√©tect√© : $last_tag"

        # Supprime le "v" du tag pour le manipuler facilement
        version=${last_tag#v}
        IFS='.' read -r major minor patch <<< "$version"

        # Incr√©mente le dernier chiffre (patch)
        patch=$((patch + 1))
        new_tag="v$major.$minor.$patch"

        echo "üè∑Ô∏è Nouveau tag : $new_tag"
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -a "$new_tag" -m "Version $new_tag"
        git push origin "$new_tag"