name: Post‑merge versioning

on:
  push:
    branches: [ master ]
  pull_request: # À chaque pull request
    branches:
    - master        # Vers master

jobs:
  version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - uses: gittools/actions/gitversion/setup@v0.12.0
        with:
          versionSpec: '6.3.0'

      - id: gitversion
        uses: gittools/actions/gitversion/execute@v0.12.0

      - name: Force minor increment and write AssemblyInfo.cs
        run: |
          major="${{ steps.gitversion.outputs.major }}"
          minor="${{ steps.gitversion.outputs.minor }}"
          patch="${{ steps.gitversion.outputs.patch }}"
          build="${{ steps.gitversion.outputs.buildMetaData }}"

          # Incrément manuel du minor
          new_minor=$((minor + 1))
          new_version="$major.$new_minor.$patch.$build"

          echo "New version: $new_version"

          cat > Properties/AssemblyInfo.cs <<EOF
          using System.Reflection;
          [assembly: AssemblyVersion("$new_version")]
          [assembly: AssemblyFileVersion("$new_version")]
          [assembly: AssemblyInformationalVersion("$new_version")]
          EOF

      - name: Commit AssemblyInfo.cs
        run: |
          current_minor=${{ steps.gitversion.outputs.minor }}
          next_minor=$((current_minor + 1))
          patch=${{ steps.gitversion.outputs.patch }}

          if [[ $(git status --porcelain) ]]; then
            git add Properties/AssemblyInfo.cs
            git commit -m "chore: force minor bump to 0.${next_minor}.${patch} [skip ci]"
            git push
          fi

      - name: Tag new version
        run: |
          TAG="v${{ steps.gitversion.outputs.major }}.$((steps.gitversion.outputs.minor + 1)).${{ steps.gitversion.outputs.patch }}"
          git tag -a "$TAG" -m "Version $TAG"
          git push origin "$TAG"